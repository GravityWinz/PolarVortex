name: AI Issue Handler

on:
  issues:
    types: [assigned, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process"
        required: true
        type: string

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Get default branch
        id: default_branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = repo.data.default_branch || 'dev';
            core.setOutput('default_branch', defaultBranch);
            console.log(`Default branch detected: ${defaultBranch}`);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Get issue information
        id: issue_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get issue number from different event types
            // For both 'assigned' and 'labeled' events, issue number is in payload.issue.number
            const issueNumber = context.payload.issue?.number || '${{ github.event.inputs.issue_number }}';

            // For labeled events, check if the ai-assigned label was added
            const isLabeledEvent = context.payload.action === 'labeled';
            const addedLabel = isLabeledEvent ? context.payload.label?.name : null;

            // If this is a labeled event but not the ai-assigned label, skip early
            if (isLabeledEvent && addedLabel !== 'ai-assigned') {
              console.log(`Label event for '${addedLabel}', not 'ai-assigned'. Skipping.`);
              core.setOutput('is_ai_assigned', 'false');
              core.setOutput('issue_number', issueNumber);
              core.setOutput('issue_title', '');
              core.setOutput('issue_body', '');
              core.setOutput('assignee', '');
              core.setOutput('labels', '[]');
              return;
            }

            // Get full issue details
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const assignee = issue.data.assignee?.login;
            const issueTitle = issue.data.title;
            const issueBody = issue.data.body || '';
            const labels = issue.data.labels.map(l => l.name);

            // Check if assigned to AI bot (configure this username) or has ai-assigned label
            const aiBotUsername = process.env.AI_BOT_USERNAME || 'github-actions[bot]';
            const isAssignedToAI = assignee === aiBotUsername || 
                                   assignee === process.env.AI_BOT_USERNAME ||
                                   labels.includes('ai-assigned');

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_body', issueBody);
            core.setOutput('assignee', assignee || '');
            core.setOutput('is_ai_assigned', isAssignedToAI);
            core.setOutput('labels', JSON.stringify(labels));

            console.log(`Issue #${issueNumber}: isAssignedToAI=${isAssignedToAI}, labels=${labels.join(', ')}, assignee=${assignee || 'none'}`);

            return { isAssignedToAI, issueNumber, issueTitle };

      - name: Check if AI should handle issue
        id: check_ai
        run: |
          if [ "${{ steps.issue_info.outputs.is_ai_assigned }}" != "true" ]; then
            echo "Issue not assigned to AI bot. Skipping."
            echo "assignee=${{ steps.issue_info.outputs.assignee }}"
            exit 0
          fi
          echo "AI will handle this issue"

      - name: Create feature branch
        if: steps.issue_info.outputs.is_ai_assigned == 'true'
        id: create_branch
        run: |
          ISSUE_NUM="${{ steps.issue_info.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue_info.outputs.issue_title }}"
          DEFAULT_BRANCH="${{ steps.default_branch.outputs.default_branch }}"

          # Fallback to 'dev' if default branch is not set
          if [ -z "$DEFAULT_BRANCH" ]; then
            echo "Warning: Default branch output is empty, using 'dev' as fallback"
            DEFAULT_BRANCH="dev"
          fi

          # Debug: Show what branch we're using
          echo "Using default branch: $DEFAULT_BRANCH"
          echo "Current branch: $(git branch --show-current || echo 'detached')"
          echo "Available remote branches:"
          git branch -r | head -10

          # Fetch latest from all branches
          git fetch origin

          # Verify the default branch exists remotely
          if ! git ls-remote --heads origin "$DEFAULT_BRANCH" | grep -q "$DEFAULT_BRANCH"; then
            echo "Error: Default branch '$DEFAULT_BRANCH' does not exist on origin!"
            echo "Available branches:"
            git ls-remote --heads origin | sed 's@.*refs/heads/@@' | head -10
            exit 1
          fi

          # Checkout default branch if not already on it
          CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
          if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" ]; then
            echo "Switching to default branch: $DEFAULT_BRANCH"
            git checkout -b "$DEFAULT_BRANCH" "origin/$DEFAULT_BRANCH" || git checkout "$DEFAULT_BRANCH"
          else
            echo "Already on $DEFAULT_BRANCH"
          fi

          # Ensure we're up to date
          git pull origin "$DEFAULT_BRANCH" || echo "Pull failed, continuing..."

          # Sanitize issue title for branch name
          BRANCH_NAME=$(echo "$ISSUE_TITLE" | \
            tr '[:upper:]' '[:lower:]' | \
            sed 's/[^a-z0-9]/-/g' | \
            sed 's/--*/-/g' | \
            sed 's/^-\|-$//g' | \
            head -c 50)

          BRANCH_NAME="ai/issue-$ISSUE_NUM-$BRANCH_NAME"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            git checkout -b "$BRANCH_NAME"
            echo "Created branch: $BRANCH_NAME"
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Created/checked out branch: $BRANCH_NAME"

      - name: Install dependencies
        if: steps.issue_info.outputs.is_ai_assigned == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi
          # Install AI integration dependencies
          pip install openai anthropic requests

      - name: Process issue with AI
        if: steps.issue_info.outputs.is_ai_assigned == 'true'
        id: ai_process
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5-mini
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue_info.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue_info.outputs.issue_title }}
          ISSUE_BODY: ${{ steps.issue_info.outputs.issue_body }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
        run: |
          python .github/scripts/ai_issue_processor.py

      - name: Commit changes
        if: steps.ai_process.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A
          git commit -m "AI: Work on issue #${{ steps.issue_info.outputs.issue_number }} - ${{ steps.issue_info.outputs.issue_title }}" || exit 0

          git push origin "${{ steps.create_branch.outputs.branch_name }}"

      - name: Create Pull Request
        if: steps.issue_info.outputs.is_ai_assigned == 'true' && steps.ai_process.outputs.has_changes == 'true'
        id: create_pull_request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ steps.issue_info.outputs.issue_number }}';
            const branchName = '${{ steps.create_branch.outputs.branch_name }}';
            const issueTitle = '${{ steps.issue_info.outputs.issue_title }}';

            // Check if PR already exists for this branch
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });

            if (existingPRs.data.length > 0) {
              console.log(`PR already exists: ${existingPRs.data[0].html_url}`);
              core.setOutput('pr_url', existingPRs.data[0].html_url);
              return;
            }

            // Get default branch
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = repo.data.default_branch;

            try {
              // Create new PR
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[AI] Fixes issue #${issueNumber}: ${issueTitle}`,
                head: branchName,
                base: defaultBranch,
                body: `This PR addresses issue #${issueNumber}\n\n**AI-generated changes**\n\nCloses #${issueNumber}`,
                draft: false
              });

              console.log(`Created PR: ${pr.data.html_url}`);
              core.setOutput('pr_url', pr.data.html_url);

              // Link PR to issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ü§ñ AI has started working on this issue. PR: #${pr.data.number}`
              });
            } catch (error) {
              if (error.status === 403 && error.message.includes('not permitted to create or approve pull requests')) {
                const errorMsg = `‚ùå **Error: GitHub Actions cannot create pull requests.**\n\n` +
                  `Please enable the permission in your repository settings:\n` +
                  `1. Go to **Settings** ‚Üí **Actions** ‚Üí **General**\n` +
                  `2. Scroll to **Workflow permissions**\n` +
                  `3. Select **Read and write permissions**\n` +
                  `4. Check **Allow GitHub Actions to create and approve pull requests**\n` +
                  `5. Click **Save**\n\n` +
                  `Branch created: \`${branchName}\` - You can manually create a PR if needed.`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: errorMsg
                });
                
                core.setFailed('GitHub Actions does not have permission to create pull requests. Please enable it in repository settings.');
                throw error;
              }
              throw error;
            }

      - name: Update issue status
        if: always() && steps.issue_info.outputs.is_ai_assigned == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ steps.issue_info.outputs.issue_number }}';
            const hasChanges = '${{ steps.ai_process.outputs.has_changes }}' === 'true';
            const prUrl = '${{ steps.create_pull_request.outputs.pr_url }}';

            if (hasChanges) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['ai-in-progress']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ü§ñ AI analyzed the issue but didn't make any code changes. The issue may need manual intervention or clarification.`
              });
            }
